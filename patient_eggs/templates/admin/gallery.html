{% extends "base.html" %}

{% block content %}
<div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Manage Gallery</h2>
        <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
    </div>
    
    <div class="row">
        <!-- Add New Image Form -->
        <div class="col-md-4 mb-4">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">Add New Image</div>
                <div class="card-body">
                    <form action="{{ url_for('admin.add_gallery_image') }}" method="POST">
                        <div class="mb-3 position-relative">
                            <label for="image_file" class="form-label">Image Filename</label>
                            <input type="text" class="form-control" id="image_file" name="image_file" required autocomplete="off" placeholder="Start typing...">
                            <!-- Suggestion Box -->
                            <div id="suggestions" class="list-group position-absolute w-100" style="z-index: 1000; max-height: 200px; overflow-y: auto; display: none;"></div>
                        </div>
                        
                        <!-- Preview Area -->
                        <div class="mb-3 text-center" id="preview-container" style="display: none;">
                            <img id="preview-img" src="" class="img-thumbnail" style="max-height: 150px;">
                        </div>

                        <div class="mb-3">
                            <label for="caption" class="form-label">Caption (Optional)</label>
                            <input type="text" class="form-control" id="caption" name="caption">
                        </div>
                        <div class="mb-3">
                            <label for="display_order" class="form-label">Order</label>
                            <input type="number" class="form-control" id="display_order" name="display_order" value="0">
                        </div>
                        <button type="submit" class="btn btn-success w-100">Add to Gallery</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Current Gallery -->
        <div class="col-md-8">
            <div class="row">
                {% for image in images %}
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <img src="{{ url_for('static', filename='img/' + image.image_file) }}" class="card-img-top" style="height: 150px; object-fit: cover;">
                        <div class="card-body">
                            <p class="card-text small text-muted mb-1">File: {{ image.image_file }}</p>
                            <p class="card-text fw-bold">{{ image.caption or 'No Caption' }}</p>
                            <form action="{{ url_for('admin.delete_gallery_image', image_id=image.id) }}" method="POST" onsubmit="return confirm('Remove this image?');">
                                <button type="submit" class="btn btn-sm btn-outline-danger w-100">Remove</button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('image_file');
    const suggestionsBox = document.getElementById('suggestions');
    const previewContainer = document.getElementById('preview-container');
    const previewImg = document.getElementById('preview-img');
    let allImages = [];

    // Fetch all images on load
    fetch("{{ url_for('admin.list_images') }}")
        .then(response => response.json())
        .then(data => {
            allImages = data.images;
        });

    input.addEventListener('input', function() {
        const val = this.value.toLowerCase();
        suggestionsBox.innerHTML = '';
        previewContainer.style.display = 'none';

        if (!val) {
            suggestionsBox.style.display = 'none';
            return;
        }

        const matches = allImages.filter(img => img.toLowerCase().includes(val));
        
        if (matches.length > 0) {
            suggestionsBox.style.display = 'block';
            matches.forEach(img => {
                const item = document.createElement('button');
                item.type = 'button';
                item.className = 'list-group-item list-group-item-action d-flex align-items-center justify-content-between';
                
                // Small thumbnail
                const thumb = document.createElement('img');
                thumb.src = "{{ url_for('static', filename='img/') }}" + img;
                thumb.style.width = '30px';
                thumb.style.height = '30px';
                thumb.style.objectFit = 'cover';
                thumb.className = 'me-2 rounded';

                const text = document.createElement('span');
                text.textContent = img;

                item.appendChild(thumb);
                item.appendChild(text);

                item.addEventListener('click', function() {
                    input.value = img;
                    suggestionsBox.style.display = 'none';
                    showPreview(img);
                });
                suggestionsBox.appendChild(item);
            });
        } else {
            suggestionsBox.style.display = 'none';
        }
    });

    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (e.target !== input && e.target !== suggestionsBox) {
            suggestionsBox.style.display = 'none';
        }
    });

    function showPreview(filename) {
        previewImg.src = "{{ url_for('static', filename='img/') }}" + filename;
        previewContainer.style.display = 'block';
    }
});
</script>
{% endblock %}
