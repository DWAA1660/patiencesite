{% extends "base.html" %}

{% block content %}
<div class="container-fluid my-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Media Manager</h2>
        <div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                <i class="bi bi-cloud-upload"></i> Upload Images
            </button>
            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
        </div>
    </div>

    <!-- Flashed Messages -->
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-info">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Search/Filter -->
    <div class="mb-4">
        <input type="text" id="mediaSearch" class="form-control" placeholder="Search images by name...">
    </div>

    <!-- Media Grid -->
    <div class="row g-3" id="mediaGrid">
        <!-- Populated by JS -->
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('admin.upload_media') }}" method="POST" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title">Upload Images</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select Files</label>
                        <input type="file" name="file" class="form-control" multiple accept="image/*" required>
                        <div class="form-text">Supported formats: JPG, PNG, GIF, WEBP.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Rename Modal -->
<div class="modal fade" id="renameModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('admin.rename_media') }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title">Rename Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="old_name" id="renameOldName">
                    <div class="mb-3">
                        <label class="form-label">New Filename</label>
                        <input type="text" name="new_name" id="renameNewName" class="form-control" required>
                    </div>
                    <div class="alert alert-warning small">
                        Warning: Renaming will attempt to update database references, but hardcoded links in blog content might break.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Rename</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('admin.delete_media') }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title">Delete Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="filename" id="deleteFilename">
                    <p>Are you sure you want to delete <strong id="deleteFilenameDisplay"></strong>?</p>
                    <div id="usageWarning" class="alert alert-danger" style="display: none;">
                        <strong>Warning!</strong> This image is currently used in:
                        <ul id="usageList" class="mb-0 mt-2 small"></ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete Permanently</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const grid = document.getElementById('mediaGrid');
    const searchInput = document.getElementById('mediaSearch');
    let allMedia = [];

    // Fetch Media
    fetch("{{ url_for('admin.api_media_list') }}")
        .then(res => res.json())
        .then(data => {
            allMedia = data.images;
            renderGrid(allMedia);
        });

    // Search Filter
    searchInput.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = allMedia.filter(item => item.name.toLowerCase().includes(term));
        renderGrid(filtered);
    });

    function renderGrid(items) {
        grid.innerHTML = '';
        if (items.length === 0) {
            grid.innerHTML = '<div class="col-12 text-center text-muted">No images found.</div>';
            return;
        }

        items.forEach(item => {
            const usageCount = item.usage.length;
            const badgeClass = usageCount > 0 ? 'bg-info' : 'bg-secondary';
            
            const col = document.createElement('div');
            col.className = 'col-6 col-md-4 col-lg-3 col-xl-2';
            
            col.innerHTML = `
                <div class="card h-100 shadow-sm">
                    <div class="ratio ratio-1x1 bg-light border-bottom">
                        <img src="${item.url}" class="card-img-top object-fit-cover" alt="${item.name}" loading="lazy" style="object-fit: cover;">
                    </div>
                    <div class="card-body p-2 d-flex flex-column">
                        <small class="text-break mb-2 fw-bold" style="font-size: 0.85rem;">${item.name}</small>
                        <div class="mt-auto d-flex justify-content-between align-items-center">
                            <span class="badge ${badgeClass}" title="${usageCount} usages">${usageCount} used</span>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-link text-dark p-0" data-bs-toggle="dropdown">
                                    <span style="font-size: 1.2rem;">&#8942;</span>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item rename-btn" href="#" data-name="${item.name}">Rename</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger delete-btn" href="#" data-name="${item.name}" data-usage='${JSON.stringify(item.usage)}'>Delete</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            grid.appendChild(col);
        });

        // Attach Event Listeners
        document.querySelectorAll('.rename-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const name = btn.dataset.name;
                document.getElementById('renameOldName').value = name;
                document.getElementById('renameNewName').value = name;
                new bootstrap.Modal(document.getElementById('renameModal')).show();
            });
        });

        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const name = btn.dataset.name;
                const usage = JSON.parse(btn.dataset.usage);
                
                document.getElementById('deleteFilename').value = name;
                document.getElementById('deleteFilenameDisplay').textContent = name;
                
                const warning = document.getElementById('usageWarning');
                const list = document.getElementById('usageList');
                list.innerHTML = '';
                
                if (usage.length > 0) {
                    warning.style.display = 'block';
                    usage.forEach(u => {
                        const li = document.createElement('li');
                        li.textContent = u;
                        list.appendChild(li);
                    });
                } else {
                    warning.style.display = 'none';
                }
                
                new bootstrap.Modal(document.getElementById('deleteModal')).show();
            });
        });
    }
});
</script>
{% endblock %}
