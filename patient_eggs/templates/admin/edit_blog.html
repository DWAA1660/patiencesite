{% extends "base.html" %}

{% block content %}
<div class="container my-5">
    <h2>{{ legend }}</h2>
    <form method="POST" enctype="multipart/form-data">
        <div class="mb-3">
            <label for="title" class="form-label">Title</label>
            <input type="text" class="form-control" id="title" name="title" value="{{ blog.title if blog else title }}" required>
        </div>
        
        <div class="mb-3">
            <label for="slug" class="form-label">Slug (optional)</label>
            <input type="text" class="form-control" id="slug" name="slug" value="{{ blog.slug if blog else slug }}">
            <div class="form-text">Leave blank to auto-generate from title.</div>
        </div>

        <div class="mb-3">
            <label class="form-label">Cover Image</label>
            {% if blog and blog.cover_image %}
            <div class="mb-2">
                <!-- Ensure we look in root img folder first (new system), fallback to blog/ if needed (legacy) -->
                <!-- Ideally all are moved to root, but let's assume root for now based on new logic -->
                <img src="{{ url_for('static', filename='img/' + blog.cover_image) }}" alt="Current Cover Image" style="max-height: 200px;" 
                     onerror="this.onerror=null;this.src='{{ url_for('static', filename='img/blog/' + blog.cover_image) }}';">
                <p class="text-muted small">Current: {{ blog.cover_image }}</p>
            </div>
            {% endif %}
            
            <div class="row g-2">
                <div class="col-md-6">
                    <label class="small text-muted">Select Existing</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="cover_image" name="cover_image" value="{{ blog.cover_image if blog else '' }}" placeholder="Select from library...">
                        <button class="btn btn-outline-secondary" type="button" onclick="selectCoverImage()">Select</button>
                    </div>
                </div>
                <div class="col-md-6">
                    <label class="small text-muted">Or Upload New</label>
                    <input type="file" class="form-control" id="cover_image_file" name="cover_image_file">
                </div>
            </div>
        </div>

        <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="is_published" name="is_published" {% if blog and blog.is_published %}checked{% endif %}>
            <label class="form-check-label" for="is_published">
                Publish immediately
            </label>
        </div>

        <div class="mb-3">
            <label for="content" class="form-label">Content</label>
            <textarea id="editor" name="content">{{ blog.content if blog else content }}</textarea>
        </div>

        <button type="submit" class="btn btn-primary">Save Post</button>
        <a href="{{ url_for('admin.manage_blogs') }}" class="btn btn-secondary">Cancel</a>
    </form>
</div>

{% include 'admin/_image_selector.html' %}

<script src="https://cdn.tiny.cloud/1/{{ tinymce_api_key or 'no-api-key' }}/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
<script>
    // Cover Image Selector
    function selectCoverImage() {
        window.openImageSelector(function(filename, url) {
            document.getElementById('cover_image').value = filename;
        });
    }

    // TinyMCE Init
    tinymce.init({
        selector: '#editor',
        plugins: 'image link lists table media code',
        toolbar: 'undo redo | blocks | bold italic | alignleft aligncenter alignright | bullist numlist outdent indent | link image media | code',
        // We don't need automatic uploads if we select from library, but kept for drag/drop if supported later
        images_upload_url: "{{ url_for('admin.upload_blog_image') }}", 
        automatic_uploads: true,
        file_picker_types: 'image',
        height: 500,
        
        /* Custom Image Picker using our Media Manager */
        file_picker_callback: function (cb, value, meta) {
            window.openImageSelector(function(filename, url) {
                // Provide file and title for the image dialog
                cb(url, { title: filename });
            });
        }
    });
</script>
{% endblock %}
