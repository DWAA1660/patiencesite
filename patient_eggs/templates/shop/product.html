{% extends "base.html" %}

{% block title %}{{ product.name }} - Patient Eggs{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/product.css') }}">
<style>
    /* Placeholder for any essential base styles if needed, 
       otherwise product.css should handle most styling. 
       Ensure product.css exists and contains the necessary styles. */
    .product-image-container img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }
    /* Add any other minimal base styles here if required */
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-lg-6">
            <div class="product-image-container">
                {% if product.image %}
                <img src="{{ url_for('static', filename='images/' + product.image) }}" alt="{{ product.name }}" class="img-fluid rounded">
                {% else %}
                <img src="{{ url_for('static', filename='images/default-egg.jpg') }}" alt="{{ product.name }}" class="img-fluid rounded">
                {% endif %}
            </div>
        </div>
        <div class="col-lg-6">
            <div class="product-info">
                <h1 class="product-title mb-2">{{ product.name }}</h1>
                <p class="product-price mb-3">${{ "%.2f"|format(product.price) }} per egg</p>
                
                {% if product.description %}
                    <p class="product-description mb-4">{{ product.description }}</p>
                {% endif %}

                <!-- Restore Weekly Selection Form -->
                <form id="product-form" action="{{ url_for('shop.add_to_cart') }}" method="post">
                    <input type="hidden" name="product_id" value="{{ product.id }}">
                    <div id="week-selections-inputs"></div> {# Hidden inputs for selected weeks go here #}

                    {% if product.requires_weekly_selection and available_weeks %}
                        <div class="week-selection-container card mb-4">
                            <div class="card-body">
                                <h3 class="week-selection-title card-title">Select Shipping Week(s)</h3>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6 date-selection mb-3 mb-md-0">
                                        <label for="delivery-week" class="form-label">Available Weeks:</label>
                                        <select id="delivery-week" class="form-select">
                                            <option value="">-- Select a week --</option>
                                            {% for week in available_weeks %}
                                                <option value="{{ week.id }}" data-available="{{ week.available }}">
                                                    {{ week.label }} ({{ week.available }} eggs available)
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-6 quantity-selection">
                                        <label for="week-quantity" class="form-label">Quantity for selected week:</label>
                                        <div class="quantity-input-container input-group">
                                            <button type="button" class="quantity-btn btn btn-outline-secondary" onclick="changeWeekQuantity(-1)">-</button>
                                            <input type="number" id="week-quantity" class="quantity-input form-control text-center" 
                                                   value="{{ product.min_quantity | default(1) }}" 
                                                   min="{{ product.min_quantity | default(1) }}" 
                                                   max="{{ product.max_quantity | default(100) }}">
                                            <button type="button" class="quantity-btn btn btn-outline-secondary" onclick="changeWeekQuantity(1)">+</button>
                                        </div>
                                        <small class="text-muted">Min: {{ product.min_quantity | default(1) }}</small>
                                    </div>
                                </div>

                                <div id="week-availability-info" class="alert alert-info mb-3" style="display: none;">
                                    <span id="availability-text"></span> 
                                    <span id="availability-badge" class="badge"></span>
                                </div>

                                <button type="button" id="add-week-btn" class="btn btn-secondary add-to-order-btn" disabled>
                                    Add Week Selection
                                </button>
                            </div>
                        </div>

                        <div id="selected-weeks-container" class="selected-weeks card mb-4" style="display: none;">
                            <div class="card-body">
                                <h4 class="selected-weeks-title card-title">Your Selections for {{ product.name }}</h4>
                                <ul id="selected-weeks-list" class="selected-weeks-list list-group list-group-flush"></ul>
                            </div>
                        </div>

                        <div id="order-summary" class="order-summary card mb-4" style="display: none;">
                            <div class="card-body">
                                <h4 class="order-summary-title card-title">Order Summary</h4>
                                <div class="order-summary-details">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="order-summary-label">Total Eggs Selected:</span>
                                        <span id="total-eggs" class="order-summary-value">0</span>
                                    </div>
                                    <div class="d-flex justify-content-between order-summary-total pt-2 border-top">
                                        <span class="order-summary-label fw-bold">Total Price:</span>
                                        <span id="total-price" class="order-summary-value fw-bold">$0.00</span>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary w-100 mt-3" disabled>
                                    Add Selections to Cart
                                </button>
                            </div>
                        </div>

                    {% else %}
                        {# Fallback for products NOT requiring weekly selection #}
                        <div class="quantity-selector mb-4">
                            <label for="quantity" class="form-label">Quantity:</label>
                            <div class="quantity-input-group input-group">
                                <button type="button" class="quantity-btn btn btn-outline-secondary" onclick="decreaseSimpleQuantity()">-</button>
                                <input type="number" id="quantity" name="quantity" class="quantity-input form-control text-center"
                                       value="{{ product.min_quantity | default(1) }}" 
                                       min="{{ product.min_quantity | default(1) }}" 
                                       max="{{ product.max_quantity | default(100) }}" 
                                       required>
                                <button type="button" class="quantity-btn btn btn-outline-secondary" onclick="increaseSimpleQuantity()">+</button>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-lg add-to-cart-btn">
                            Add to Cart
                        </button>
                    {% endif %}
                </form> <!-- End of main product form -->

                {% if product.hatch_rate_info %}
                <div class="card mt-4 bg-light border-0">
                    <div class="card-body">
                        <h5 class="card-title">Hatch Rate Information</h5>
                        <p class="card-text small text-muted">{{ product.hatch_rate_info }}</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const deliveryWeekSelect = document.getElementById('delivery-week');
        const weekQuantityInput = document.getElementById('week-quantity');
        const addWeekBtn = document.getElementById('add-week-btn');
        const availabilityInfo = document.getElementById('week-availability-info');
        const availabilityText = document.getElementById('availability-text');
        const availabilityBadge = document.getElementById('availability-badge');
        
        const selectedWeeksContainer = document.getElementById('selected-weeks-container');
        const selectedWeeksList = document.getElementById('selected-weeks-list');
        const orderSummary = document.getElementById('order-summary');
        const totalEggsElement = document.getElementById('total-eggs');
        const totalPriceElement = document.getElementById('total-price');
        const weekSelectionsInputs = document.getElementById('week-selections-inputs');
        const finalSubmitBtn = orderSummary.querySelector('button[type="submit"]');

        const productPrice = parseFloat(document.querySelector('meta[name="product-price"]').content);
        const minQuantityPerWeek = parseInt(weekQuantityInput.min);
        const maxQuantityPerWeek = parseInt(weekQuantityInput.max); // Max per individual week selection
        
        let selectedWeeks = {}; // { weekId: { quantity: x, label: 'Week ending...' } }
        let currentMaxAvailableForWeek = 0;

        // --- Event Listeners ---
        deliveryWeekSelect.addEventListener('change', handleWeekChange);
        weekQuantityInput.addEventListener('input', handleQuantityChange);
        addWeekBtn.addEventListener('click', addSelectedWeek);

        // --- Functions ---
        function handleWeekChange() {
            const selectedOption = deliveryWeekSelect.options[deliveryWeekSelect.selectedIndex];
            const weekId = selectedOption.value;
            
            if (weekId) {
                currentMaxAvailableForWeek = parseInt(selectedOption.dataset.available);
                availabilityInfo.style.display = 'block';
                updateAvailabilityDisplay();
                validateSelection();
            } else {
                availabilityInfo.style.display = 'none';
                currentMaxAvailableForWeek = 0;
                addWeekBtn.disabled = true;
            }
        }

        function handleQuantityChange() {
            validateSelection();
        }
        
        window.changeWeekQuantity = function(amount) {
            let currentValue = parseInt(weekQuantityInput.value);
            let newValue = currentValue + amount;
            // Clamp value between min and max allowed for the input itself
            newValue = Math.max(minQuantityPerWeek, Math.min(maxQuantityPerWeek, newValue));
            weekQuantityInput.value = newValue;
            handleQuantityChange(); // Trigger validation
        }

        function validateSelection() {
            const weekId = deliveryWeekSelect.value;
            const quantity = parseInt(weekQuantityInput.value);
            
            if (!weekId || isNaN(quantity)) {
                addWeekBtn.disabled = true;
                return;
            }

            const alreadySelectedQuantity = selectedWeeks[weekId] ? selectedWeeks[weekId].quantity : 0;
            const availableForSelection = currentMaxAvailableForWeek; // Already considers previously selected amounts for *other* weeks
            
            // Check basic quantity rules
            if (quantity < minQuantityPerWeek || quantity > maxQuantityPerWeek) {
                 weekQuantityInput.classList.add('is-invalid');
                 addWeekBtn.disabled = true;
                 return;
            } else {
                 weekQuantityInput.classList.remove('is-invalid');
            }
            
            // Check availability for the selected week
            if (quantity > availableForSelection) {
                addWeekBtn.disabled = true;
                // Optionally show a more specific message in availabilityInfo
            } else {
                addWeekBtn.disabled = false;
            }
        }

        function updateAvailabilityDisplay() {
            const selectedOption = deliveryWeekSelect.options[deliveryWeekSelect.selectedIndex];
            const weekId = selectedOption.value;
            if (!weekId) return;

            const available = currentMaxAvailableForWeek; 
            availabilityText.textContent = `Available for ${selectedOption.text.split(' (')[0]}: ${available} eggs.`;
            
            if (available >= minQuantityPerWeek) {
                availabilityBadge.textContent = 'Available';
                availabilityBadge.className = 'badge bg-success';
            } else {
                availabilityBadge.textContent = 'Unavailable';
                availabilityBadge.className = 'badge bg-danger';
            }
        }
        
        function addSelectedWeek() {
            const weekId = deliveryWeekSelect.value;
            const quantity = parseInt(weekQuantityInput.value);
            const selectedOption = deliveryWeekSelect.options[deliveryWeekSelect.selectedIndex];
            const weekLabel = selectedOption.text.split(' (')[0]; // Get clean label
            const availableBeforeAdd = parseInt(selectedOption.dataset.available);

            if (!weekId || isNaN(quantity) || quantity < minQuantityPerWeek || quantity > availableBeforeAdd) {
                // Should not happen if button is enabled correctly, but double check
                return; 
            }

            // Update selectedWeeks object
            if (selectedWeeks[weekId]) {
                // If week already selected, update quantity (we'll adjust availability later)
                selectedWeeks[weekId].quantity = quantity;
            } else {
                selectedWeeks[weekId] = { quantity: quantity, label: weekLabel };
            }

            // Update availability in dropdown
            const newAvailable = availableBeforeAdd - quantity;
            selectedOption.dataset.available = newAvailable;
            selectedOption.text = `${weekLabel} (${newAvailable} eggs available)`;
            currentMaxAvailableForWeek = newAvailable; // Update current context

            // Update UI
            updateSelectedWeeksList();
            updateOrderSummary();
            updateHiddenInputs();

            // Reset selection controls
            deliveryWeekSelect.value = '';
            weekQuantityInput.value = minQuantityPerWeek;
            availabilityInfo.style.display = 'none';
            addWeekBtn.disabled = true;
        }

        function updateSelectedWeeksList() {
            selectedWeeksList.innerHTML = ''; // Clear current list
            const weekIds = Object.keys(selectedWeeks);
            
            if (weekIds.length === 0) {
                selectedWeeksContainer.style.display = 'none';
                orderSummary.style.display = 'none';
                return;
            }

            selectedWeeksContainer.style.display = 'block';
            orderSummary.style.display = 'block';

            for (const weekId of weekIds) {
                const week = selectedWeeks[weekId];
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                
                const weekText = document.createElement('span');
                weekText.textContent = `${week.label}: `; 
                
                const quantityBadge = document.createElement('span');
                quantityBadge.className = 'badge bg-primary rounded-pill me-2';
                quantityBadge.textContent = `${week.quantity} eggs`;

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn btn-sm btn-outline-danger';
                removeBtn.innerHTML = '&times;'; // Cross icon
                removeBtn.onclick = () => removeWeekSelection(weekId);

                const actionDiv = document.createElement('div');
                actionDiv.className = 'd-flex align-items-center';
                actionDiv.appendChild(quantityBadge);
                actionDiv.appendChild(removeBtn);

                li.appendChild(weekText);
                li.appendChild(actionDiv);
                selectedWeeksList.appendChild(li);
            }
        }
        
        function removeWeekSelection(weekIdToRemove) {
            if (!selectedWeeks[weekIdToRemove]) return;

            const removedQuantity = selectedWeeks[weekIdToRemove].quantity;
            delete selectedWeeks[weekIdToRemove];

            // Restore availability in dropdown
            for (let i = 0; i < deliveryWeekSelect.options.length; i++) {
                const option = deliveryWeekSelect.options[i];
                if (option.value === weekIdToRemove) {
                    const currentAvailable = parseInt(option.dataset.available);
                    const newAvailable = currentAvailable + removedQuantity;
                    const weekLabel = option.text.split(' (')[0];
                    option.dataset.available = newAvailable;
                    option.text = `${weekLabel} (${newAvailable} eggs available)`;
                    // If this week is currently selected in dropdown, update context
                    if (deliveryWeekSelect.value === weekIdToRemove) {
                        currentMaxAvailableForWeek = newAvailable;
                        handleWeekChange(); // Re-validate controls
                    }
                    break;
                }
            }
            
            // Update UI
            updateSelectedWeeksList();
            updateOrderSummary();
            updateHiddenInputs();
        }

        function updateOrderSummary() {
            const totalEggs = calculateTotalEggs();
            const totalPrice = totalEggs * productPrice;
            
            totalEggsElement.textContent = totalEggs;
            totalPriceElement.textContent = formatCurrency(totalPrice);
            
            finalSubmitBtn.disabled = totalEggs === 0;
        }

        function updateHiddenInputs() {
            weekSelectionsInputs.innerHTML = ''; // Clear previous
            for (const weekId in selectedWeeks) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = weekId; // Set name directly to the week ID (e.g., '2025-12')
                input.value = selectedWeeks[weekId].quantity;
                weekSelectionsInputs.appendChild(input);
            }
        }

        function calculateTotalEggs() {
            return Object.values(selectedWeeks).reduce((sum, week) => sum + week.quantity, 0);
        }

        function formatCurrency(amount) {
            return '$' + amount.toFixed(2);
        }
        
        // Initial setup if needed
        handleWeekChange(); // Set initial state based on dropdown
    });
    </script>

{% endblock %}

{% block scripts %}
{{ super() }}

{# Ensure product metadata is available for JavaScript #}
<meta name="product-price" content="{{ product.price }}">
<meta name="min-quantity" content="{{ product.min_quantity | default(1) }}">
<meta name="max-quantity" content="{{ product.max_quantity | default(100) }}">

{% if not product.requires_weekly_selection or not available_weeks %}
{# Script for non-weekly selection products #}
<script>
    // Basic quantity control functions
    const quantityInput = document.getElementById('quantity');
    const minQuantity = parseInt(quantityInput.min);
    const maxQuantity = parseInt(quantityInput.max);

    function increaseSimpleQuantity() {
        let currentValue = parseInt(quantityInput.value);
        if (currentValue < maxQuantity) {
            quantityInput.value = currentValue + 1;
        }
    }

    function decreaseSimpleQuantity() {
        let currentValue = parseInt(quantityInput.value);
        if (currentValue > minQuantity) {
            quantityInput.value = currentValue - 1;
        }
    }
    
    quantityInput?.addEventListener('change', function() { // Add safe navigation ?. 
        let value = parseInt(this.value);
        if (isNaN(value) || value < minQuantity) {
            this.value = minQuantity;
        } else if (value > maxQuantity) {
            this.value = maxQuantity;
        }
    });
</script>
{% endif %}
{% endblock %}
